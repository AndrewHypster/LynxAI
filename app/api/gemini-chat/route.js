import { GoogleGenAI } from "@google/genai";
import { NextResponse } from "next/server";
// –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ 'shop-bd.json' –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —É –∫–æ—Ä–µ–Ω–µ–≤–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ –∞–±–æ –≤ 'src/'
// —ñ –µ–∫—Å–ø–æ—Ä—Ç—É—î –º–∞—Å–∏–≤ —Ç–æ–≤–∞—Ä—ñ–≤ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.
import shop from "@/shop-bd.json";
import sendTelegramNotification from "../telegram-bot/route";

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è AI (—Ä–æ–±—ñ—Ç—å —Ü–µ –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ POST, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });
const MODEL_NAME = "gemini-2.5-flash"; // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è —á–∞—Ç—É

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏–π shop)
const getProductData = () => {
  // –¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó, —è–∫—â–æ –∫–∞—Ç–∞–ª–æ–≥ –≤–µ–ª–∏–∫–∏–π
  return shop;
};

const telegramTool = {
  functionDeclarations: [
    {
      name: "sendTelegramNotification",
      description:
        '–í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä—É –º–∞–≥–∞–∑–∏–Ω—É, –∫–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –≤–∏—Å–ª–æ–≤–ª—é—î —á—ñ—Ç–∫–µ –±–∞–∂–∞–Ω–Ω—è –∑–¥—ñ–π—Å–Ω–∏—Ç–∏ –ø–æ–∫—É–ø–∫—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–∞–∂–µ "–•–æ—á—É –∫—É–ø–∏—Ç–∏", "–ì–æ—Ç–æ–≤–∏–π –∑–∞–º–æ–≤–ª—è—Ç–∏" –∞–±–æ "–û—Ñ–æ—Ä–º–ª—é–π—Ç–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è".',
      parameters: {
        type: "OBJECT",
        properties: {
          message: {
            type: "STRING",
            description:
              "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞. –ú–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–∞–ø–∏—Ç –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —Ç–æ–≤–∞—Ä, —è–∫—â–æ —Ü–µ –º–æ–∂–ª–∏–≤–æ.",
          },
        },
        required: ["message"],
      },
    },
  ],
};

export async function POST(req) {
  try {
    const { history } = await req.json(); // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É

    // --- 1. –ü–Ü–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ò–• –¢–ê –ü–†–û–ú–ü–¢–ê ---

    // –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ —Ç–æ–≤–∞—Ä–∏
    const productData = getProductData();
    // –ö—Ä–∞—â–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –¥–∞–Ω—ñ —è–∫ JSON-—Ä—è–¥–æ–∫, —â–æ–± AI –º—ñ–≥ —ó—Ö –ª–µ–≥–∫–æ –æ–±—Ä–æ–±–∏—Ç–∏
    const productsString = JSON.stringify(productData, null, 2);

    // –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –°–∏—Å—Ç–µ–º–Ω–æ–≥–æ Prompt
    const systemInstruction = `–¢–∏ ‚Äì –µ–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—É. –¢–≤–æ—è –º–µ—Ç–∞ ‚Äì –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É –≤–∏–±—Ä–∞—Ç–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π —Ç–æ–≤–∞—Ä. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ç—ñ–ª—å–∫–∏ —Ü—ñ –¥–∞–Ω—ñ –ø—Ä–æ —Ç–æ–≤–∞—Ä–∏ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó: \n\n<CATALOG>${productsString}</CATALOG>\n\n–ë—É–¥—å –≤–≤—ñ—á–ª–∏–≤–∏–º —Ç–∞ –¥—Ä—É–∂–Ω—ñ–º. –ü—Ä–æ–ø–æ–Ω—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ç–æ–≤–∞—Ä–∏ –∑ —ó—Ö–Ω—ñ–º–∏ –Ω–∞–∑–≤–∞–º–∏, —Ü—ñ–Ω–∞–º–∏ —Ç–∞ –ø–µ—Ä–µ–≤–∞–≥–∞–º–∏. –î–∞–≤–∞–π –∫–æ—Ä–æ—Ç–∫—ñ —Ç–∞ —á—ñ—Ç–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –º–∞—Ä–∫–¥–∞—É–Ω. –Ø–∫—à–æ –∫–ª—ñ—î–Ω—Ç —à–æ—Å—å —Ö–æ—á–µ –∫—É–ø–∏—Ç–∏ —Å–ø–µ—Ä—à—É –≤–∑–Ω–∞–π —ñ–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –º–æ–∂–µ –ø–æ—à—Ç—É –∞–±–æ —Ç–µ–ª–µ–≥—Ä–∞–º —ñ —Ç–æ–¥—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–π –∑–∞—è–≤–∫—É`;

    // 3. –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è –º–æ–¥–µ–ª—ñ (Gemini)
    const geminiHistory = history.map((msg) => ({
      // Gemini –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î 'model' –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π, –∞ –Ω–µ 'assistant'
      role: msg.role === "assistant" ? "model" : msg.role,
      parts: [{ text: msg.content }],
    }));

    // --- 4. –í–ò–ö–õ–ò–ö GEMINI API ---

    // –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É: –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ chat.sendMessage –∞–±–æ generateContent
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –∫–æ–Ω—Ç–µ–Ω—Ç—É, –ø–µ—Ä–µ–¥–∞—é—á–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é —Ç–∞ —Å–∏—Å—Ç–µ–º–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é
    const response = await ai.models.generateContent({
      model: MODEL_NAME,
      contents: geminiHistory,
      config: {
        systemInstruction: systemInstruction,
        tools: [telegramTool], // –ü–µ—Ä–µ–¥–∞—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å—é–¥–∏
      },
    });

    if (response.functionCalls && response.functionCalls.length > 0) {
      const call = response.functionCalls[0];

      if (call.name === "sendTelegramNotification") {
        const { message } = call.args;

        // --- 4. –í–ò–ö–õ–ò–ö –§–ê–ö–¢–ò–ß–ù–û–ì–û –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢–ê ---
        await sendTelegramNotification(
          `üî• –ó–ê–ú–û–í–õ–ï–ù–ù–Ø –ß–ï–†–ï–ó AI –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê üî•\n\n–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞: ${message}`
        );

        // --- 5. –î–†–£–ì–ò–ô –í–ò–ö–õ–ò–ö GEMINI API ---
        // –ü—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó, –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–∑–∞–¥ –¥–æ Gemini,
        // —â–æ–± –≤–æ–Ω–∞ –º–æ–≥–ª–∞ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ—î–Ω—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–î—è–∫—É—é, –∑–∞—Ä–∞–∑ –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è...").

        const secondResponse = await ai.models.generateContent({
          model: MODEL_NAME,
          contents: [
            ...geminiHistory,
            // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó
            {
              role: "model",
              parts: [{ functionCall: call }],
            },
            // –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó
            {
              role: "function",
              parts: [
                {
                  functionResponse: {
                    name: "sendTelegramNotification",
                    response: { status: "success" }, // –ê–±–æ —Å—Ç–∞—Ç—É—Å –ø–æ–º–∏–ª–∫–∏
                  },
                },
              ],
            },
          ],
          config: {
            systemInstruction: systemInstruction,
            tools: [telegramTool],
          },
        });

        return NextResponse.json({ text: secondResponse.text });
      }
    }

    const aiResponseText = response.text;

    // --- 5. –í–Ü–î–ü–û–í–Ü–î–¨ –§–†–û–ù–¢–ï–ù–î–£ ---
    return NextResponse.json({
      text: aiResponseText,
    });
  } catch (error) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É:", error);
    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É 500
    return NextResponse.json(
      { error: "–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≤'—è–∑–∞—Ç–∏—Å—è –∑ AI." },
      { status: 500 }
    );
  }
}
